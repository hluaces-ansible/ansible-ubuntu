---
name: Renovate
run-name: Renovate for ${{ github.event_name }}:${{ github.ref }} (${{ github.sha }})

on:
  schedule:
    - cron: "12 */5 * * *"

  workflow_dispatch:
    inputs:
      log_level:
        description: "Renovate log level"
        required: false
        default: "info"
        type: choice
        options:
          - debug
          - info
          - warn
          - error

concurrency:
  group: renovate
  cancel-in-progress: false

jobs:
  renovate:
    name: Renovate
    runs-on: self-hosted
    container:
      image: renovate/renovate:42@sha256:e526fd2286124c15a1b89d935f271e8030567750cb54f430df772732628154ee
      volumes:
        - /home/github/.cache/renovate:/tmp/renovate/cache
      options: >-
        --user 1001:1001
        --cpus 2
        --memory 2g

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Run Renovate
        env:
          RENOVATE_TOKEN: ${{ secrets.GH_TOKEN_RENOVATE }}
          RENOVATE_REPOSITORIES: ${{ github.repository }}
          RENOVATE_REPOSITORY_CACHE: enabled
          RENOVATE_CACHE_DIR: /tmp/renovate/cache
          RENOVATE_PLATFORM: github
          RENOVATE_ENDPOINT: https://api.github.com
          RENOVATE_ONBOARDING: false
          RENOVATE_REQUIRE_CONFIG: required
          LOG_LEVEL: ${{ inputs.log_level || 'info' }}
          RENOVATE_LOG_FILE: renovate.log
          RENOVATE_LOG_FILE_LEVEL: debug
          RENOVATE_GIT_AUTHOR: "Renovate Bot <bot@renovateapp.com>"
          RENOVATE_AUTODISCOVER: false
        run: |
          echo "Starting Renovate..."
          renovate

      - name: Upload Renovate log
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: renovate-log-${{ github.run_number }}
          path: renovate.log
          retention-days: 30
