---
name: Renovate
run-name: Renovate for ${{ github.event_name }}:${{ github.ref }} (${{ github.sha }})

on:
  schedule:
    - cron: "12 */5 * * *"

  workflow_dispatch:
    inputs:
      log_level:
        description: "Renovate log level"
        required: false
        default: "info"
        type: choice
        options:
          - debug
          - info
          - warn
          - error

concurrency:
  group: renovate
  cancel-in-progress: false

jobs:
  renovate:
    name: Renovate
    runs-on: self-hosted
    container:
      image: renovate/renovate:43@sha256:f4c0cc245a2452b53bdcdfa772ab07373fb2189c500b6a4d671bd10b5310d49f
      volumes:
        - /home/github/.cache/renovate:/tmp/renovate/cache
      options: >-
        --user 1001:1001
        --cpus 2
        --memory 2g

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run Renovate
        env:
          RENOVATE_TOKEN: ${{ secrets.GH_TOKEN_RENOVATE }}
          RENOVATE_REPOSITORIES: ${{ github.repository }}
          RENOVATE_REPOSITORY_CACHE: enabled
          RENOVATE_CACHE_DIR: /tmp/renovate/cache
          RENOVATE_PLATFORM: github
          RENOVATE_ENDPOINT: https://api.github.com
          RENOVATE_ONBOARDING: false
          RENOVATE_REQUIRE_CONFIG: required
          LOG_LEVEL: ${{ inputs.log_level || 'info' }}
          RENOVATE_LOG_FILE: renovate.log
          RENOVATE_LOG_FILE_LEVEL: debug
          RENOVATE_GIT_AUTHOR: "Renovate Bot <bot@renovateapp.com>"
          RENOVATE_AUTODISCOVER: false
        run: |
          echo "Starting Renovate..."
          renovate

      - name: Upload Renovate log
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: renovate-log-${{ github.run_number }}
          path: renovate.log
          retention-days: 30
