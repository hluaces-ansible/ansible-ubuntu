---
name: Renovate
run-name: Renovate for ${{ github.event_name }}:${{ github.ref }} (${{ github.sha }})

on:
  schedule:
    - cron: "0 23 * * 0-4"

  workflow_dispatch:
    inputs:
      log_level:
        description: "Renovate log level"
        required: false
        default: "info"
        type: choice
        options:
          - debug
          - info
          - warn
          - error

concurrency:
  group: renovate
  cancel-in-progress: false

jobs:
  renovate:
    name: Renovate
    runs-on: self-hosted
    container:
      image: renovate/renovate:latest
      volumes:
        - /home/github/.cache/renovate:/tmp/renovate/cache
      options: >-
        --user 1001:1001
        --cpus 2
        --memory 2g

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Run Renovate
        env:
          RENOVATE_TOKEN: ${{ secrets.GH_TOKEN_RENOVATE }}
          RENOVATE_REPOSITORIES: ${{ github.repository }}
          RENOVATE_REPOSITORY_CACHE: enabled
          RENOVATE_CACHE_DIR: /tmp/renovate/cache
          RENOVATE_PLATFORM: github
          RENOVATE_ENDPOINT: https://api.github.com
          RENOVATE_ONBOARDING: true
          RENOVATE_REQUIRE_CONFIG: required
          LOG_LEVEL: ${{ inputs.log_level || 'info' }}
          RENOVATE_LOG_FILE: renovate.log
          RENOVATE_LOG_FILE_LEVEL: debug
          RENOVATE_GIT_AUTHOR: "Renovate Bot <bot@renovateapp.com>"
          RENOVATE_AUTODISCOVER: false
        run: |
          echo "Starting Renovate..."
          renovate

      - name: Upload Renovate log
        if: always()
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: renovate-log-${{ github.run_number }}
          path: renovate.log
          retention-days: 30
